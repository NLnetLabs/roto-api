#!/bin/bash

arg="$1"

if [ "$1" != "" ] && [ "$1" != "--dry-run" ] && [ "$arg" != "--force-sync" ]; then
  echo "download delegated extended files from RIRs"
  echo "usage: update-status-del-ext [--dry-run|--force-sync]"
  echo 
  echo "set envvar ROTO_API_PEER to sync to peer" 
  exit 0
fi

if [ "$ROTO_API_PEER" = "" ] && [ "$arg" != "--dry-run" ]; then
  echo "Error: Set envvar ROTO_API_PEER to sync to peer" 
  exit 1
fi


# move to the dir of the repo this script is in
cd "$(dirname "$0")"
cd ..

changed=false

for rir in afrinic,https://ftp.afrinic.net/pub/stats/afrinic/delegated-afrinic-extended-latest, \
	apnic,https://ftp.apnic.net/stats/apnic/delegated-apnic-extended-latest, \
	arin,https://ftp.arin.net/pub/stats/arin/delegated-arin-extended-latest, \
	lacnic,https://ftp.lacnic.net/pub/stats/lacnic/delegated-lacnic-extended-latest,  \
	ripencc,https://ftp.ripe.net/pub/stats/ripencc/delegated-ripencc-extended-latest, \
;do IFS=","
	set -- $rir
	echo ----------------------------------
	echo "$1" | tr [a-z] [A-Z]
	cur_ts=`cat downloads/"$1"_h.txt | /home/roto/.cargo/bin/rg -e '^Last-Modified: (.+)$' --replace '$1'`
	echo local download time: $cur_ts

	next_ts=`curl -s --HEAD $2 | /home/roto/.cargo/bin/rg -e '^Last-Modified: (.+)$' --replace '$1'`
	echo remote download time: $next_ts

	# "not equal" isn't enough: Arin moves Last-Modified header backwards.
	if [ `date --date="$cur_ts" "+%s"` -ge `date --date="$next_ts" "+%s"` ]; then
		echo UNCHANGED
	else
		echo CHANGED
		changed=true
		if [ "$arg" != "--dry-run" ]; then
			echo downloading $2
			scripts/download-del-ext "$1"
		fi
	fi
done

if [ "$arg" != "--dry-run" ]; then
	if [ "$changed" = true ]; then
		echo -------------------
			echo restarting roto-api daemon...
			XDG_RUNTIME_DIR="/run/user/1000" \
			DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/1000/bus" \
			systemctl --user restart roto-api
		else
			echo no updates, exiting...
	fi
else
	echo changed="$changed"
	echo this was a dry-run, no files were changed
	exit 0
fi

if [ "$changed" = true ] || [ "$arg" == "--force-sync" ]; then
    echo sending this to peer...
    rsync -Cavz --delete data/ "$ROTO_API_PEER":/home/roto/ris_alloc_api/data/
    ssh roto@"$ROTO_API_PEER" "systemctl --user restart roto-api"
else
    echo nothing changed, skipping writing to "$ROTO_API_PEER"
fi
